"""
Migration tab component for data migration monitoring
Reads statistics from JSON files generated by CLI migration script
"""
import streamlit as st
import pandas as pd
import time
import subprocess
import os
import json
from pathlib import Path
from services.migration.stats_writer import StatsWriter
from services.migration.test_run_manager import TestRunManager


def render_migration_tab():
    """Render data migration tab with JSON-based monitoring"""
    st.header("ğŸ”„ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜")
    st.markdown("ê¸°ì¡´ ì…ì°° ë°ì´í„°ë¥¼ PostgreSQL í…Œì´ë¸”ì— ë§ˆì´ê·¸ë ˆì´ì…˜í•©ë‹ˆë‹¤.")

    # Initialize stats reader
    stats_writer = StatsWriter()

    col1, col2 = st.columns([2, 1])

    with col1:
        st.subheader("ğŸ“ ë°ì´í„° íŒŒì¼ í˜„í™©")

        # ë°ì´í„° ë””ë ‰í† ë¦¬ í™•ì¸
        data_path = Path("data")
        if data_path.exists():
            json_files = [f for f in data_path.glob("*.json") if f.name != "sample_data.json"]

            if json_files:
                st.success(f"âœ… {len(json_files)}ê°œì˜ ë°ì´í„° íŒŒì¼ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.")

                # íŒŒì¼ ëª©ë¡ í‘œì‹œ
                file_info = []
                total_size = 0

                for file_path in sorted(json_files):
                    size_mb = file_path.stat().st_size / (1024 * 1024)
                    total_size += size_mb

                    table_name = "Unknown"
                    if file_path.name.startswith("PubDataOpnStdService_ScsBidInfo_"):
                        table_name = "opn_std_scsbid_info"

                    file_info.append({
                        "íŒŒì¼ëª…": file_path.name,
                        "í¬ê¸° (MB)": f"{size_mb:.2f}",
                        "ëŒ€ìƒ í…Œì´ë¸”": table_name
                    })

                df_files = pd.DataFrame(file_info)
                st.dataframe(df_files)

                st.info(f"ì´ ë°ì´í„° í¬ê¸°: {total_size:.2f} MB")

                # CLI ì‹¤í–‰ ì•ˆë‚´
                st.markdown("---")
                st.subheader("ğŸš€ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰")

                st.markdown("""
                ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í•˜ë ¤ë©´ í„°ë¯¸ë„ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:

                **ê¸°ë³¸ ì‹¤í–‰ (ë°°ì¹˜ 1000ê°œ, ë‹¨ì¼ ì»¤ë„¥ì…˜):**
                ```bash
                python migrate_cli.py
                ```

                **ë°°ì¹˜ í¬ê¸° ë³€ê²½ (100ê°œ):**
                ```bash
                python migrate_cli.py --batch-size 100
                ```

                **ë©€í‹° ì»¤ë„¥ì…˜ (10ê°œ):**
                ```bash
                python migrate_cli.py --connections 10
                ```

                **ë°°ì¹˜ 100ê°œ + ì»¤ë„¥ì…˜ 10ê°œ:**
                ```bash
                python migrate_cli.py --batch-size 100 --connections 10
                ```

                **ì˜µì…˜:**
                - `--batch-size`: ë°°ì¹˜ í¬ê¸° (100, 500, 1000, 2000, 5000)
                - `--connections`: ë™ì‹œ ì»¤ë„¥ì…˜ ìˆ˜ (1, 2, 5, 10)
                - `--output-dir`: í†µê³„ ì €ì¥ ë””ë ‰í† ë¦¬
                """)

                # ê°„í¸ ì‹¤í–‰ ë²„íŠ¼ (ì„ íƒì‚¬í•­)
                if st.button("ğŸš€ ì—¬ê¸°ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)"):
                    try:
                        # Start migration in background
                        venv_python = Path("venv/bin/python")
                        if venv_python.exists():
                            python_cmd = str(venv_python)
                        else:
                            python_cmd = "python"

                        process = subprocess.Popen(
                            [python_cmd, "migrate_cli.py"],
                            stdout=subprocess.PIPE,
                            stderr=subprocess.PIPE,
                            text=True
                        )
                        st.success(f"âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ë¨ (PID: {process.pid})")
                        st.info("ğŸ“Š ì•„ë˜ì—ì„œ ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™©ì„ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

                        # Store process info in session state
                        if 'migration_process' not in st.session_state:
                            st.session_state.migration_process = process

                    except Exception as e:
                        st.error(f"âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘ ì‹¤íŒ¨: {e}")

            else:
                st.warning("ë°ì´í„° íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        else:
            st.error("data ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    with col2:
        st.subheader("ğŸ“‹ ìµœê·¼ í…ŒìŠ¤íŠ¸ ì‹¤í–‰")

        # Initialize test run manager
        test_manager = TestRunManager()

        # Get recent test runs
        recent_runs = test_manager.get_recent_test_runs(limit=5)

        if recent_runs:
            for run in recent_runs:
                status_icon = 'âœ…' if run['status'] == 'completed' else ('ğŸ”„' if run['status'] == 'running' else 'âŒ')
                timestamp = run['timestamp'][:19] if run.get('timestamp') else 'N/A'
                provider = run.get('cloud_provider', 'Unknown')
                instance = run.get('instance_type', 'Unknown')
                batch = run.get('batch_size', 0)
                conn = run.get('num_connections', 0)
                rps = run.get('average_records_per_second', 0)

                with st.expander(f"{status_icon} {timestamp} - {provider}"):
                    st.write(f"**Instance:** {instance}")
                    st.write(f"**Batch Size:** {batch}")
                    st.write(f"**Connections:** {conn}")
                    if run['status'] == 'completed':
                        st.write(f"**Throughput:** {rps:.1f} rec/s")
                        st.write(f"**Duration:** {run.get('total_duration_seconds', 0):.1f}s")
                    elif run['status'] == 'error':
                        st.error(f"Error: {run.get('error_message', 'Unknown error')}")
        else:
            st.info("ì•„ì§ ì‹¤í–‰ëœ í…ŒìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.")

        # Auto-refresh button
        if st.button("ğŸ”„ ìƒíƒœ ìƒˆë¡œê³ ì¹¨"):
            st.rerun()